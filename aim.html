<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>Gold FPS V3 - Dual Stick</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: monospace; color: #ffd700; }
        canvas { display: block; }
        
        #ui { position: absolute; top: 10px; left: 10px; z-index: 10; pointer-events: none; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 14px; height: 14px; border: 2px solid #ffd700; transform: translate(-50%, -50%); border-radius: 50%; pointer-events: none; z-index: 10; }
        
        /* Joysticks */
        .joystick-container { position: absolute; bottom: 30px; width: 120px; height: 120px; background: rgba(255, 215, 0, 0.1); border: 2px solid #ffd700; border-radius: 50%; touch-action: none; }
        #move-joy { left: 40px; }
        #fire-joy { right: 40px; background: rgba(255, 0, 0, 0.1); border-color: #ff4444; }
        .knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: #ffd700; border-radius: 50%; transform: translate(-50%, -50%); }
        
        #weapon-select { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; }
        button { background: #000; color: #ffd700; border: 1px solid #ffd700; padding: 10px; font-weight: bold; border-radius: 5px; }
        .active { background: #ffd700; color: #000; }
    </style>
</head>
<body>

    <div id="ui">SCORE: <span id="score">0</span> | AMMO: <span id="ammo">--</span></div>
    <div id="crosshair"></div>
    
    <div id="weapon-select">
        <button id="p-btn" onclick="setWep('pistol')">PISTOL</button>
        <button id="m-btn" onclick="setWep('mg')">MACHINE GUN</button>
    </div>

    <div id="move-joy" class="joystick-container"><div class="knob" id="move-knob"></div></div>
    
    <div id="fire-joy" class="joystick-container"><div class="knob" id="fire-knob"></div></div>

    <script>
        // --- WEAPON SPECS ---
        const weapons = {
            pistol: { name: 'Pistol', fireRate: 400, recoil: 0.02, spread: 0.01, auto: false, mag: 12 },
            mg: { name: 'Machine Gun', fireRate: 100, recoil: 0.05, spread: 0.04, auto: true, mag: 50 }
        };
        let curWep = 'pistol';
        let ammo = 12;
        let isFiring = false;
        let score = 0;

        // --- THREE.JS SCENE ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio > 1 ? 1.5 : 1);
        document.body.appendChild(renderer.domElement);

        // Floor & Grid
        const grid = new THREE.GridHelper(20, 20, 0xffd700, 0x333333);
        scene.add(grid);

        // Simple Gun Model
        const gun = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.1, 0.5), new THREE.MeshBasicMaterial({color: 0x444444}));
        gun.position.set(0.2, -0.2, -0.4);
        camera.add(gun);
        scene.add(camera);
        camera.position.y = 1.6;

        // --- TARGET SYSTEM ---
        let targets = [];
        function spawn() {
            const t = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.8, 0.1), new THREE.MeshBasicMaterial({color: 0xff0000}));
            t.position.set((Math.random()-0.5)*15, 1, -Math.random()*10 - 5);
            t.userData = { vx: (Math.random()-0.5)*0.05, vy: (Math.random()-0.5)*0.02 };
            scene.add(t);
            targets.push(t);
        }
        for(let i=0; i<5; i++) spawn();

        // --- JOYSTICK LOGIC ---
        const moveData = { x: 0, y: 0 };
        const fireData = { x: 0, y: 0 };

        function handleJoystick(id, knobId, dataObj, onStart, onEnd) {
            const container = document.getElementById(id);
            const knob = document.getElementById(knobId);
            
            container.addEventListener('touchstart', (e) => {
                if(onStart) onStart();
            }, {passive: false});

            container.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                const rect = container.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                let dx = (touch.clientX - centerX) / (rect.width / 2);
                let dy = (touch.clientY - centerY) / (rect.height / 2);
                
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist > 1) { dx /= dist; dy /= dist; }
                
                dataObj.x = dx; dataObj.y = dy;
                knob.style.transform = `translate(calc(-50% + ${dx * 40}px), calc(-50% + ${dy * 40}px))`;
            }, {passive: false});

            container.addEventListener('touchend', () => {
                dataObj.x = 0; dataObj.y = 0;
                knob.style.transform = `translate(-50%, -50%)`;
                if(onEnd) onEnd();
            });
        }

        handleJoystick('move-joy', 'move-knob', moveData);
        handleJoystick('fire-joy', 'fire-knob', fireData, () => { isFiring = true; fireLoop(); }, () => { isFiring = false; });

        // --- SHOOTING ---
        const raycaster = new THREE.Raycaster();
        function fire() {
            if (ammo <= 0) return;
            const w = weapons[curWep];
            ammo--;
            document.getElementById('ammo').innerText = ammo;

            // Recoil
            camera.rotation.x += w.recoil;
            gun.position.z = -0.3; setTimeout(() => gun.position.z = -0.4, 50);

            // Hitscan
            raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = raycaster.intersectObjects(targets);
            if (hits.length > 0) {
                const h = hits[0].object;
                scene.remove(h);
                targets = targets.filter(t => t !== h);
                score += 100;
                document.getElementById('score').innerText = score;
                setTimeout(spawn, 1000);
            }
        }

        let lastFire = 0;
        function fireLoop() {
            if (!isFiring) return;
            const now = Date.now();
            if (now - lastFire > weapons[curWep].fireRate) {
                fire();
                lastFire = now;
            }
            if (weapons[curWep].auto) requestAnimationFrame(fireLoop);
        }

        window.setWep = (type) => {
            curWep = type;
            ammo = weapons[type].mag;
            document.getElementById('ammo').innerText = ammo;
            document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            document.getElementById(type === 'pistol' ? 'p-btn' : 'm-btn').classList.add('active');
        };
        setWep('pistol');

        // --- CORE LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            // Movement (Left Stick)
            camera.translateZ(moveData.y * 0.1);
            camera.translateX(moveData.x * 0.1);
            camera.position.y = 1.6;

            // Aiming (Right Stick)
            camera.rotation.y -= fireData.x * 0.04;
            camera.rotation.x -= fireData.y * 0.04;

            // Target Movement
            targets.forEach(t => {
                t.position.x += t.userData.vx;
                if(Math.abs(t.position.x) > 8) t.userData.vx *= -1;
            });

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
